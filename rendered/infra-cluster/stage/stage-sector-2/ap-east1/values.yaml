cluster:
  environment: stage
  sector: stage-sector-2
  region: ap-east1
applications:
  argocd:
    project: default
    namespace: argocd
    finalizers:
    - resources-finalizer.argocd.argoproj.io
    syncPolicy:
      automated:
        prune: false
        selfHeal: true
      syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
    destination:
      name: '{{`{{ .Values.cluster.name }}`}}'
      namespace: argocd
    source:
      repoURL: https://argoproj.github.io/argo-helm
      targetRevision: 5.46.0
      chart: argo-cd
      helm:
        valuesObject:
          server:
            service:
              type: ClusterIP
          controller:
            replicas: 1
          repoServer:
            replicas: 1
applicationsets:
  infra-cluster-root:
    project: default
    namespace: argocd
    finalizers:
    - resources-finalizer.argocd.argoproj.io
    syncPolicy:
      preserveResourcesOnDeletion: false
    generators:
    - clusters:
        selector:
          matchLabels:
            gcp-hcp/cluster-type: infra-cluster
        values:
          environment: '{{ .Values.cluster.environment }}'
          sector: '{{ .Values.cluster.sector }}'
          region: '{{ .Values.cluster.region }}'
    template:
      metadata:
        name: infra-apps-{{`{{.name}}`}}
        labels:
          cluster: '{{`{{.name}}`}}'
          cluster-type: infra-cluster
          environment: '{{ .Values.cluster.environment }}'
          sector: '{{ .Values.cluster.sector }}'
          region: '{{ .Values.cluster.region }}'
      spec:
        project: default
        source:
          repoURL: https://github.com/company/gcp-hcp-apps
          targetRevision: HEAD
          path: rendered/infra-cluster/{{ .Values.cluster.environment }}/{{ .Values.cluster.sector }}/{{ .Values.cluster.region }}
          helm:
            valuesObject:
              cluster:
                region: '{{ .Values.cluster.region }}'
                environment: '{{ .Values.cluster.environment }}'
                sector: '{{ .Values.cluster.sector }}'
                projectId: '{{`{{"{{"}} index .metadata.annotations "gcp-hcp/project-id" {{"}}"}}`}}'
                vpcId: '{{`{{"{{"}} index .metadata.annotations "gcp-hcp/vpc-id" {{"}}"}}`}}'
        destination:
          server: '{{`{{.server}}`}}'
          namespace: argocd
        syncPolicy:
          automated:
            prune: true
            selfHeal: true
          syncOptions:
          - CreateNamespace=true
  management-cluster-root:
    project: default
    namespace: argocd
    finalizers:
    - resources-finalizer.argocd.argoproj.io
    syncPolicy:
      preserveResourcesOnDeletion: false
    generators:
    - clusters:
        selector:
          matchLabels:
            gcp-hcp/cluster-type: management-cluster
        values:
          environment: '{{ .Values.cluster.environment }}'
          sector: '{{ .Values.cluster.sector }}'
          region: '{{ .Values.cluster.region }}'
    template:
      metadata:
        name: mgmt-apps-{{`{{.name}}`}}
        labels:
          cluster: '{{`{{.name}}`}}'
          cluster-type: management-cluster
          environment: '{{ .Values.cluster.environment }}'
          sector: '{{ .Values.cluster.sector }}'
          region: '{{ .Values.cluster.region }}'
      spec:
        project: default
        source:
          repoURL: https://github.com/company/gcp-hcp-apps
          targetRevision: HEAD
          path: rendered/management-cluster/{{ .Values.cluster.environment }}/{{ .Values.cluster.sector }}/{{ .Values.cluster.region }}
          helm:
            valuesObject:
              cluster:
                name: '{{ .name }}'
                region: '{{ .Values.cluster.region }}'
                environment: '{{ .Values.cluster.environment }}'
                sector: '{{ .Values.cluster.sector }}'
                projectId: '{{`{{"{{"}} index .metadata.annotations "gcp-hcp/project-id" {{"}}"}}`}}'
                vpcId: '{{`{{"{{"}} index .metadata.annotations "gcp-hcp/vpc-id" {{"}}"}}`}}'
        destination:
          server: '{{`{{.server}}`}}'
          namespace: argocd
        syncPolicy:
          automated:
            prune: true
            selfHeal: true
          syncOptions:
          - CreateNamespace=false
