# ArgoCD Bootstrap Architecture

## Overview

This document describes how GCP HCP management clusters are bootstrapped using ArgoCD with the App of Apps pattern.

## Bootstrap Flow

### 1. Infrastructure & Initial Bootstrap
```
terraform apply
├── Creates GKE cluster infrastructure
├── Deploys initial ArgoCD installation
└── Creates root Application pointing to gcp-hcp-apps repo
    (with lifecycle.ignore_changes=all)
```

### 2. GitOps Takeover
```
ArgoCD Root Application
├── Points to: management-clusters/ Helm chart
├── Values file: values-{environment}.yaml
└── Deploys all Application templates:
    ├── argocd-app.yaml (ArgoCD self-management)
    ├── prometheus-app.yaml
    ├── cert-manager-app.yaml
    ├── hypershift-app.yaml
    └── Additional workload applications
```

### 3. Self-Management
- **Terraform**: Only bootstraps ArgoCD initially (ignore_changes=all)
- **ArgoCD**: Takes over its own lifecycle management via argocd-app.yaml
- **All workloads**: Managed through GitOps from this repository

## Repository Structure

```
gcp-hcp-apps/
├── management-clusters/              # Root Helm chart for all applications
│   ├── Chart.yaml
│   ├── values.yaml                   # Default application configurations
│   ├── values-dev.yaml               # Dev environment overrides
│   ├── values-prod.yaml              # Prod environment overrides
│   └── templates/                    # ArgoCD Application templates
│       ├── argocd-app.yaml           # ArgoCD self-management
│       ├── prometheus-app.yaml       # Monitoring stack
│       ├── cert-manager-app.yaml     # Certificate management
│       └── hypershift-app.yaml       # Hypershift operator
├── hypershift/                       # Raw YAML manifests
│   ├── hypershift-dev.yaml           # Generated from hypershift binary
│   └── README.md                     # Generation instructions
└── BOOTSTRAP-ARCHITECTURE.md         # This document
```

## Key Components

### Root Helm Chart (management-clusters/)
- **Chart.yaml**: Defines the root Helm chart
- **values.yaml**: Default configurations for all applications
- **values-{env}.yaml**: Environment-specific overrides
- **templates/**: ArgoCD Application definitions

### Application Templates
Each template creates an ArgoCD Application that manages a specific workload:
- **argocd-app.yaml**: Manages ArgoCD itself (self-management)
- **prometheus-app.yaml**: Deploys monitoring stack via Helm chart
- **cert-manager-app.yaml**: Deploys certificate management via Helm chart
- **hypershift-app.yaml**: Deploys hypershift operator via raw manifests

### Workload Manifests
- **hypershift/**: Contains raw Kubernetes manifests generated by hypershift binary
- Additional workload directories can be added as needed

## Benefits

✅ **Minimal Bootstrap**: Single Terraform resource creates root application
✅ **Self-Updating**: ArgoCD updates itself and all applications from Git
✅ **Environment Support**: Different configurations per environment
✅ **Technology Agnostic**: Supports Helm charts and raw manifests
✅ **GitOps Native**: All changes flow through Git with proper review